# gRPC Service Registration Timing Issue

## å•é¡Œèªªæ˜

åœ¨å¯¦ä½œ mDNS æœå‹™æ¢ç´¢æ™‚ï¼Œé‡åˆ°ä»¥ä¸‹ gRPC éŒ¯èª¤ï¼š

```
FATAL: [core] grpc: Server.RegisterService after Server.Serve
```

æ­¤éŒ¯èª¤ç™¼ç”Ÿæ–¼ `arx.node.v1.DiscoveryService` æœå‹™è¨»å†Šæ™‚ã€‚

## æ ¹æœ¬åŸå› åˆ†æ

### å•é¡Œçš„æ™‚åºåœ–ï¼ˆåŸå§‹è¨­è¨ˆï¼‰

```
æ™‚é–“è»¸
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

main.go
  â†“
èª¿ç”¨ server.New()
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ server.New() å…§éƒ¨åŸ·è¡Œ                                    â”‚
â”‚                                                         â”‚
â”‚  1. å»ºç«‹ Unix Socket Listener                          â”‚
â”‚  2. å»ºç«‹ gRPC Server                                   â”‚
â”‚  3. å•Ÿå‹• Serve() in Goroutine (èƒŒæ™¯åŸ·è¡Œ)              â”‚
â”‚                                                         â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚     â”‚ Goroutine: grpcSrv.Serve()                 â”‚   â”‚
â”‚     â”‚ âš ï¸  é–‹å§‹ç›£è½ Unix Socket                   â”‚   â”‚
â”‚     â”‚ âš ï¸  ä¸å†æ¥å—æ–°æœå‹™è¨»å†Šï¼                  â”‚   â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                         â”‚
â”‚  âŒ ç«‹å³è¿”å› Server å¯¦ä¾‹                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
server.New() è¿”å›
  â†“
main.go è©¦åœ–è¨»å†Š DiscoveryService
  â†“
âŒ éŒ¯èª¤ï¼æœå‹™å·²ç¶“é–‹å§‹ Serve()ï¼Œç„¡æ³•å†è¨»å†Šæ–°æœå‹™
```

### ç¨‹å¼æµç¨‹ï¼ˆåŸå§‹ï¼‰

```go
// server.go - åŸå§‹è¨­è¨ˆ
func New(config *Config) (*Server, error) {
    // ... åˆå§‹åŒ–ç¨‹å¼ç¢¼ ...

    s := &Server{
        config:    config,
        srv:       srv,
        listener:  listener,
    }

    // âŒ å•é¡Œï¼šåœ¨ New() å…§å•Ÿå‹• Serve()
    go func() {
        s.srv.Serve(s.listener)  // é–‹å§‹ç›£è½ï¼Œé—œé–‰æœå‹™è¨»å†Šè¦–çª—
    }()

    return s, nil  // ç«‹å³è¿”å›ï¼Œæœªçµ¦äºˆæœå‹™è¨»å†Šçš„æ©Ÿæœƒ
}

// main.go - å˜—è©¦è¨»å†Šæœå‹™
manager, _ := server.NewManager(managerCfg)
grpcSrv := manager.GRPCServer()

// âŒ æ­¤æ™‚ gRPC Server å·²ç¶“åœ¨ Serve()ï¼Œç„¡æ³•è¨»å†Šæ–°æœå‹™
v1.RegisterDiscoveryServiceServer(grpcSrv.GetServer(), handler)
```

### ç‚ºä»€éº¼æœƒå¤±æ•—ï¼Ÿ

gRPC çš„è¨­è¨ˆé™åˆ¶ï¼š
1. ä¸€æ—¦ `server.Serve()` é–‹å§‹åŸ·è¡Œï¼Œå°±æœƒé€²å…¥ç›£è½è¿´åœˆ
2. gRPC Server åœ¨ Serve() ä¸­æœƒé–å®šæœå‹™åˆ—è¡¨
3. ä»»ä½•å¾ŒçºŒçš„ `RegisterService()` å‘¼å«éƒ½æœƒè¢«æ‹’çµ•

é€™æ˜¯ gRPC çš„å®‰å…¨è¨­è¨ˆï¼Œé˜²æ­¢æœå‹™åœ¨é‹è¡Œä¸­é€”è¢«ä¿®æ”¹ã€‚

## è§£æ±ºæ–¹æ¡ˆ

### æœå‹™ç”Ÿå‘½é€±æœŸé‡æ–°è¨­è¨ˆ

```
æ™‚é–“è»¸
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Phase 1: ä¼ºæœå™¨å»ºç«‹ï¼ˆä¸å•Ÿå‹•ï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
main.go
  â†“
èª¿ç”¨ server.New()
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ server.New()                                    â”‚
â”‚                                                 â”‚
â”‚  âœ“ å»ºç«‹ Unix Socket Listener                   â”‚
â”‚  âœ“ å»ºç«‹ gRPC Server                            â”‚
â”‚  âœ“ NOT Serving - ä¿æŒæœªå•Ÿå‹•ç‹€æ…‹                â”‚
â”‚                                                 â”‚
â”‚  âœ“ è¿”å› Server å¯¦ä¾‹                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Phase 2: æœå‹™è¨»å†Šï¼ˆé—œéµæ™‚åˆ»ï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
main.go
  â†“
å–å¾— gRPC Server å¯¦ä¾‹
  â†“
âœ“ è¨»å†Š DiscoveryService
  â†“
âœ“ æ‰€æœ‰æœå‹™å·²å°±ä½

Phase 3: å•Ÿå‹•ä¼ºæœå™¨ï¼ˆé–‹å§‹ç›£è½ï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
manager.Start()
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ manager.Start() å…§éƒ¨                            â”‚
â”‚                                                 â”‚
â”‚  go func() {                                    â”‚
â”‚      grpcSrv.Serve()  âœ“ ç¾åœ¨å•Ÿå‹•              â”‚
â”‚  }()                                            â”‚
â”‚                                                 â”‚
â”‚  mDNS Advertiser.Start()                       â”‚
â”‚  periodic TXT update loop                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
âš ï¸  æ­¤æ™‚æ‰€æœ‰æœå‹™å·²è¨»å†Šï¼ŒServe() é–‹å§‹ç›£è½
```

### æ”¹é€²å¾Œçš„ç¨‹å¼ç¢¼

#### server.go - åˆ†é›¢åˆå§‹åŒ–å’Œæœå‹™

```go
// New åªè² è²¬å»ºç«‹ï¼Œä¸å•Ÿå‹•æœå‹™
func New(config *Config) (*Server, error) {
    // ... é©—è­‰å’Œåˆå§‹åŒ– ...

    listener, err := net.Listen("unix", config.SocketPath)
    if err != nil {
        return nil, fmt.Errorf("failed to listen on unix socket %s: %w",
            config.SocketPath, err)
    }

    srv := grpc.NewServer()
    healthSrv := health.NewServer()
    healthCheck := NewHealthCheck(config.Logger)

    // è¨»å†Šå¥åº·æª¢æŸ¥å’Œåå°„
    grpc_health_v1.RegisterHealthServer(srv, healthSrv)
    reflection.Register(srv)

    s := &Server{
        config:      config,
        srv:         srv,
        healthSrv:   healthSrv,
        healthCheck: healthCheck,
        listener:    listener,
    }

    return s, nil  // è¿”å›ï¼Œä½†ä¸å•Ÿå‹• Serve()
}

// Serve æ˜¯ä¸€å€‹ç¨ç«‹æ–¹æ³•ï¼Œç”± Manager åœ¨é©ç•¶æ™‚æ©Ÿèª¿ç”¨
// ï¼ˆåœ¨æ‰€æœ‰æœå‹™è¨»å†Šä¹‹å¾Œï¼‰
func (s *Server) Serve() error {
    s.config.Logger.Info("gRPC server listening", "socket", s.config.SocketPath)
    return s.srv.Serve(s.listener)  // ç¾åœ¨å•Ÿå‹•ç›£è½
}
```

#### manager.go - åœ¨æœå‹™è¨»å†Šå¾Œå•Ÿå‹• Serve()

```go
func (m *Manager) Start(ctx context.Context) error {
    m.mu.Lock()
    if m.running {
        m.mu.Unlock()
        return errors.New("manager already running")
    }
    m.running = true
    m.mu.Unlock()

    m.logger.Info("starting manager")

    // å•Ÿå‹• gRPC server in goroutine
    // ï¼ˆæ­¤æ™‚æ‰€æœ‰æœå‹™å·²åœ¨ main.go ä¸­è¨»å†Šï¼‰
    if m.grpcSrv != nil {
        go func() {
            if err := m.grpcSrv.Serve(); err != nil {
                m.logger.Error("grpc server error", "err", err)
            }
        }()
    }

    // å•Ÿå‹• mDNS advertiser
    if m.advertiser != nil {
        // ...
    }

    // ç­‰å¾…ä¸Šä¸‹æ–‡å–æ¶ˆ
    <-ctx.Done()
    m.logger.Info("context cancelled, shutting down")
    m.Stop()
    return ctx.Err()
}
```

#### main.go - æ”¹é€²çš„æœå‹™è¨»å†Šæµç¨‹

```go
func main() {
    // ... åˆå§‹åŒ–å’Œæ—¥èªŒè¨­ç½® ...

    ctx, cancel := signal.NotifyContext(context.Background(),
        syscall.SIGINT, syscall.SIGTERM)
    defer cancel()

    // Phase 1: å»ºç«‹ç®¡ç†å™¨ï¼ˆå»ºç«‹ä¼ºæœå™¨ä½†ä¸å•Ÿå‹•ï¼‰
    manager, err := server.NewManager(managerCfg)
    if err != nil {
        logger.Error("failed to create server manager", "err", err)
        return
    }

    // Phase 2: è¨»å†Šæ‰€æœ‰æœå‹™
    grpcSrv := manager.GRPCServer()
    scanner := manager.GetScanner()
    discoveryHandler := server.NewDiscoveryHandler(scanner, logger)

    // âœ“ æœå‹™è¨»å†ŠæˆåŠŸï¼ˆæ­¤æ™‚ Serve() é‚„æœªå•Ÿå‹•ï¼‰
    v1.RegisterDiscoveryServiceServer(grpcSrv.GetServer(), discoveryHandler)
    logger.Info("DiscoveryService registered")

    // Phase 3: å•Ÿå‹•ä¼ºæœå™¨ï¼ˆé–‹å§‹ç›£è½ï¼‰
    // Serve() æœƒåœ¨ manager.Start() å…§çš„ goroutine ä¸­å•Ÿå‹•
    if err := manager.Start(ctx); err != nil {
        logger.Error("server manager error", "err", err)
        return
    }
}
```

## å°æ¯”ç¸½çµ

### åŸå§‹è¨­è¨ˆçš„å•é¡Œ

| å•é¡Œ | å½±éŸ¿ |
|------|------|
| New() å…§è‡ªå‹•å•Ÿå‹• Serve() | æœå‹™è¨»å†Šè¦–çª—ç«‹å³é—œé–‰ |
| åŒæ­¥å•Ÿå‹•ï¼Œç«‹å³è¿”å› | ç„¡æ³•æ§åˆ¶æœå‹™æº–å‚™æ™‚æ©Ÿ |
| ç„¡æ³•å»¶é² Serve() | ç„¡æ³•åœ¨å•Ÿå‹•å‰è¨»å†Šå‹•æ…‹æœå‹™ |

### æ”¹é€²è¨­è¨ˆçš„å„ªå‹¢

| å„ªå‹¢ | èªªæ˜ |
|------|------|
| âœ“ ä¸‰ç›¸å•Ÿå‹•æµç¨‹ | å»ºç«‹ â†’ è¨»å†Š â†’ æœå‹™ |
| âœ“ æ¸…æ™°çš„è²¬ä»»åŠƒåˆ† | New() åªå»ºç«‹ï¼ŒStart() è² è²¬å•Ÿå‹• |
| âœ“ æ”¯æ´å‹•æ…‹æœå‹™è¨»å†Š | å¯åœ¨æœå‹™å•Ÿå‹•å‰çš„ä»»ä½•æ™‚åˆ»è¨»å†Š |
| âœ“ gRPC è¦ç¯„éµå¾ª | å®Œå…¨ç¬¦åˆ gRPC çš„è¨­è¨ˆè¦æ±‚ |
| âœ“ æ›´å¥½çš„æ¸¬è©¦èƒ½åŠ› | å¯å€‹åˆ¥æ¸¬è©¦å„å€‹ç”Ÿå‘½é€±æœŸéšæ®µ |

## æ™‚åºåœ–å°æ¯”

### åŸå§‹è¨­è¨ˆï¼ˆå¤±æ•—ï¼‰
```
main()
  â”‚
  â”œâ”€â†’ New()
  â”‚    â”‚
  â”‚    â”œâ”€â†’ å»ºç«‹ Listener âœ“
  â”‚    â”œâ”€â†’ å»ºç«‹ gRPC Server âœ“
  â”‚    â”œâ”€â†’ Serve() in Goroutine ğŸ”’ (é–å®šè¨»å†Š)
  â”‚    â””â”€â†’ return Server
  â”‚
  â”œâ”€â†’ RegisterDiscoveryServiceServer()  âŒ å¤±æ•—ï¼
  â”‚
  â””â”€â†’ Start()
```

### æ”¹é€²è¨­è¨ˆï¼ˆæˆåŠŸï¼‰
```
main()
  â”‚
  â”œâ”€â†’ New()
  â”‚    â”‚
  â”‚    â”œâ”€â†’ å»ºç«‹ Listener âœ“
  â”‚    â”œâ”€â†’ å»ºç«‹ gRPC Server âœ“
  â”‚    â””â”€â†’ return Server (æœªå•Ÿå‹•)
  â”‚
  â”œâ”€â†’ RegisterDiscoveryServiceServer()  âœ“ æˆåŠŸï¼
  â”‚
  â””â”€â†’ Start()
       â”‚
       â”œâ”€â†’ go Serve() (ç¾åœ¨å•Ÿå‹•ï¼Œæœå‹™å·²æº–å‚™)
       â”‚
       â”œâ”€â†’ go Advertiser.Start()
       â”‚
       â””â”€â†’ go periodicUpdate()
```

## é—œéµå­¸ç¿’

1. **åˆ†é›¢é—œæ³¨é»**: ä¼ºæœå™¨å»ºç«‹å’Œæœå‹™å•Ÿå‹•æ‡‰åˆ†é–‹è™•ç†
2. **é¡¯å¼ç”Ÿå‘½é€±æœŸ**: æä¾›æ˜ç¢ºçš„åˆå§‹åŒ–ã€è¨»å†Šã€æœå‹™ä¸‰éšæ®µ
3. **gRPC é™åˆ¶**: ç†è§£ gRPC Server ä¸€æ—¦ Serve() å¾Œçš„è¡Œç‚ºé™åˆ¶
4. **å¯æ¸¬è©¦æ€§**: åˆ†é›¢è¨­è¨ˆä½¿å–®å…ƒæ¸¬è©¦æ›´å®¹æ˜“ç·¨å¯«
