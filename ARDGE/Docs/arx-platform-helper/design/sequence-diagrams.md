# 元件互動時序圖

## 1. 建立 Tunnel 完整流程

```
┌────────┐     ┌─────────┐     ┌─────────┐     ┌───────────┐     ┌───────────┐
│ Client │     │ API     │     │ Service │     │ CF Client │     │Cloudflare │
└───┬────┘     └────┬────┘     └────┬────┘     └─────┬─────┘     └─────┬─────┘
    │               │               │                │                 │
    │ POST /tunnels │               │                │                 │
    │──────────────►│               │                │                 │
    │               │               │                │                 │
    │               │ Validate      │                │                 │
    │               │ API Key       │                │                 │
    │               │───────┐       │                │                 │
    │               │       │       │                │                 │
    │               │◄──────┘       │                │                 │
    │               │               │                │                 │
    │               │ Parse &       │                │                 │
    │               │ Validate JSON │                │                 │
    │               │───────┐       │                │                 │
    │               │       │       │                │                 │
    │               │◄──────┘       │                │                 │
    │               │               │                │                 │
    │               │ Create()      │                │                 │
    │               │──────────────►│                │                 │
    │               │               │                │                 │
    │               │               │ CreateTunnel() │                 │
    │               │               │───────────────►│                 │
    │               │               │                │                 │
    │               │               │                │ POST /cfd_tunnel│
    │               │               │                │────────────────►│
    │               │               │                │                 │
    │               │               │                │ 201 Created     │
    │               │               │                │ {id, token}     │
    │               │               │                │◄────────────────│
    │               │               │                │                 │
    │               │               │ Tunnel         │                 │
    │               │               │◄───────────────│                 │
    │               │               │                │                 │
    │               │               │ [If Ingress provided]            │
    │               │               │                │                 │
    │               │               │ UpdateConfig() │                 │
    │               │               │───────────────►│                 │
    │               │               │                │ PUT /config     │
    │               │               │                │────────────────►│
    │               │               │                │◄────────────────│
    │               │               │◄───────────────│                 │
    │               │               │                │                 │
    │               │ TunnelResponse│                │                 │
    │               │◄──────────────│                │                 │
    │               │               │                │                 │
    │ 201 Created   │               │                │                 │
    │ {tunnel}      │               │                │                 │
    │◄──────────────│               │                │                 │
    │               │               │                │                 │
```

## 2. 啟動 Tunnel 流程

```
┌────────┐     ┌─────────┐     ┌─────────┐     ┌───────────┐     ┌───────────┐     ┌───────────┐
│ Client │     │ API     │     │ Service │     │ CF Client │     │ ProcMgr   │     │cloudflared│
└───┬────┘     └────┬────┘     └────┬────┘     └─────┬─────┘     └─────┬─────┘     └─────┬─────┘
    │               │               │                │                 │                 │
    │ POST /:id/    │               │                │                 │                 │
    │      start    │               │                │                 │                 │
    │──────────────►│               │                │                 │                 │
    │               │               │                │                 │                 │
    │               │ Auth Check    │                │                 │                 │
    │               │───────┐       │                │                 │                 │
    │               │◄──────┘       │                │                 │                 │
    │               │               │                │                 │                 │
    │               │ Start()       │                │                 │                 │
    │               │──────────────►│                │                 │                 │
    │               │               │                │                 │                 │
    │               │               │ Check Status   │                 │                 │
    │               │               │───────────────────────────────────►                │
    │               │               │                │                 │                 │
    │               │               │ [If Running]   │                 │                 │
    │               │               │◄─ Error: TUNNEL_RUNNING ─────────│                 │
    │               │               │                │                 │                 │
    │               │               │ GetToken()     │                 │                 │
    │               │               │───────────────►│                 │                 │
    │               │               │                │ GET /token      │                 │
    │               │               │                │────────────────►│                 │
    │               │               │                │◄────────────────│                 │
    │               │               │◄───────────────│                 │                 │
    │               │               │                │                 │                 │
    │               │               │ Start(token)   │                 │                 │
    │               │               │────────────────────────────────►│                 │
    │               │               │                │                 │                 │
    │               │               │                │                 │ exec()          │
    │               │               │                │                 │────────────────►│
    │               │               │                │                 │                 │
    │               │               │                │                 │ Store PID       │
    │               │               │                │                 │───────┐         │
    │               │               │                │                 │◄──────┘         │
    │               │               │                │                 │                 │
    │               │               │                │                 │ [Async] Monitor │
    │               │               │                │                 │─ ─ ─ ─ ─ ─ ─ ─►│
    │               │               │                │                 │                 │
    │               │               │◄────────────────────────────────│                 │
    │               │               │                │                 │                 │
    │               │◄──────────────│                │                 │                 │
    │               │               │                │                 │                 │
    │ 200 OK        │               │                │                 │                 │
    │ {status:      │               │                │                 │                 │
    │  started}     │               │                │                 │                 │
    │◄──────────────│               │                │                 │                 │
```

## 3. 停止 Tunnel 流程

```
┌────────┐     ┌─────────┐     ┌─────────┐     ┌───────────┐     ┌───────────┐
│ Client │     │ API     │     │ Service │     │ ProcMgr   │     │cloudflared│
└───┬────┘     └────┬────┘     └────┬────┘     └─────┬─────┘     └─────┬─────┘
    │               │               │                │                 │
    │ POST /:id/    │               │                │                 │
    │      stop     │               │                │                 │
    │──────────────►│               │                │                 │
    │               │               │                │                 │
    │               │ Stop()        │                │                 │
    │               │──────────────►│                │                 │
    │               │               │                │                 │
    │               │               │ Stop()         │                 │
    │               │               │───────────────►│                 │
    │               │               │                │                 │
    │               │               │                │ Get Process     │
    │               │               │                │───────┐         │
    │               │               │                │◄──────┘         │
    │               │               │                │                 │
    │               │               │                │ SIGTERM         │
    │               │               │                │────────────────►│
    │               │               │                │                 │
    │               │               │                │                 │ Graceful
    │               │               │                │                 │ Shutdown
    │               │               │                │                 │───┐
    │               │               │                │                 │   │
    │               │               │                │                 │◄──┘
    │               │               │                │                 │
    │               │               │                │ [Wait or        │
    │               │               │                │  Timeout]       │
    │               │               │                │                 │
    │               │               │                │ [If Timeout]    │
    │               │               │                │ SIGKILL         │
    │               │               │                │- - - - - - - - ►│
    │               │               │                │                 │
    │               │               │                │ Update State    │
    │               │               │                │───────┐         │
    │               │               │                │◄──────┘         │
    │               │               │                │                 │
    │               │               │◄───────────────│                 │
    │               │               │                │                 │
    │               │◄──────────────│                │                 │
    │               │               │                │                 │
    │ 200 OK        │               │                │                 │
    │◄──────────────│               │                │                 │
```

## 4. 錯誤處理流程

```
┌────────┐     ┌─────────┐     ┌─────────┐     ┌───────────┐
│ Client │     │ API     │     │ Service │     │Cloudflare │
└───┬────┘     └────┬────┘     └────┬────┘     └─────┬─────┘
    │               │               │                │
    │ POST /tunnels │               │                │
    │ {invalid}     │               │                │
    │──────────────►│               │                │
    │               │               │                │
    │               │ Validate      │                │
    │               │───────┐       │                │
    │               │ FAIL  │       │                │
    │               │◄──────┘       │                │
    │               │               │                │
    │ 400 Bad       │               │                │
    │ Request       │               │                │
    │ {error:       │               │                │
    │  CONFIG_      │               │                │
    │  INVALID}     │               │                │
    │◄──────────────│               │                │
    │               │               │                │
    ├───────────────┼───────────────┼────────────────┤
    │               │               │                │
    │ POST /tunnels │               │                │
    │ {valid}       │               │                │
    │──────────────►│               │                │
    │               │               │                │
    │               │ Create()      │                │
    │               │──────────────►│                │
    │               │               │                │
    │               │               │ CreateTunnel() │
    │               │               │───────────────►│
    │               │               │                │
    │               │               │ [API Error]    │
    │               │               │◄─── 401 ───────│
    │               │               │                │
    │               │ Error         │                │
    │               │◄──────────────│                │
    │               │               │                │
    │ 502 Bad       │               │                │
    │ Gateway       │               │                │
    │ {error:       │               │                │
    │  CLOUDFLARE_  │               │                │
    │  ERROR}       │               │                │
    │◄──────────────│               │                │
```

## 5. cloudflared 進程監控

```
┌───────────┐     ┌───────────┐     ┌───────────┐
│ ProcMgr   │     │cloudflared│     │Cloudflare │
└─────┬─────┘     └─────┬─────┘     └─────┬─────┘
      │                 │                 │
      │ [After Start]   │                 │
      │                 │                 │
      │ goroutine:      │                 │
      │ monitor()       │                 │
      │───────┐         │                 │
      │       │         │                 │
      │◄──────┘         │                 │
      │                 │                 │
      │                 │ Connect (QUIC)  │
      │                 │────────────────►│
      │                 │                 │
      │                 │◄────────────────│
      │                 │                 │
      │                 │ [Running...]    │
      │                 │                 │
      │ Wait()          │                 │
      │─ ─ ─ ─ ─ ─ ─ ─►│                 │
      │                 │                 │
      │                 │    [Scenario A: Normal Exit]
      │                 │                 │
      │ exit 0          │                 │
      │◄─ ─ ─ ─ ─ ─ ─ ─│                 │
      │                 │                 │
      │ Update State:   │                 │
      │ STOPPED         │                 │
      │───────┐         │                 │
      │◄──────┘         │                 │
      │                 │                 │
      ├─────────────────┼─────────────────┤
      │                 │                 │
      │                 │    [Scenario B: Crash]
      │                 │                 │
      │ exit 1          │                 │
      │◄─ ─ ─ ─ ─ ─ ─ ─│                 │
      │                 │                 │
      │ Update State:   │                 │
      │ FAILED          │                 │
      │───────┐         │                 │
      │◄──────┘         │                 │
      │                 │                 │
      │ Log Error       │                 │
      │───────┐         │                 │
      │◄──────┘         │                 │
      │                 │                 │
      │ [Optional]      │                 │
      │ Auto Restart?   │                 │
      │                 │                 │
```

## 6. 資料流向總圖

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Data Flow Overview                                 │
└─────────────────────────────────────────────────────────────────────────────┘

  ┌──────────────────────────────────────────────────────────────────────────┐
  │                              Control Flow                                 │
  │                                                                           │
  │    Client ──► API Handler ──► Service Layer ──► CF Client ──► Cloudflare │
  │                                    │                            API       │
  │                                    │                                      │
  │                                    └──► Process Manager ──► cloudflared   │
  │                                                                           │
  └──────────────────────────────────────────────────────────────────────────┘

  ┌──────────────────────────────────────────────────────────────────────────┐
  │                              Data Flow                                    │
  │                                                                           │
  │  Request DTO ──► Domain Model ──► CF API Request ──► CF API Response     │
  │       │                                                    │              │
  │       │                                                    ▼              │
  │       │                                             Domain Model          │
  │       │                                                    │              │
  │       ▼                                                    ▼              │
  │  Validation                                         Response DTO          │
  │                                                                           │
  └──────────────────────────────────────────────────────────────────────────┘

  ┌──────────────────────────────────────────────────────────────────────────┐
  │                           Secret Flow                                     │
  │                                                                           │
  │  Environment ──┐                                                          │
  │                │                                                          │
  │  Vault/KMS ────┼──► Secret Provider ──► Config ──► Components            │
  │                │                                                          │
  │  K8s Secret ───┘                                                          │
  │                                                                           │
  │  Note: Tunnel Token 不持久化，執行時從 Cloudflare API 取得                 │
  │                                                                           │
  └──────────────────────────────────────────────────────────────────────────┘

  ┌──────────────────────────────────────────────────────────────────────────┐
  │                           Log Flow                                        │
  │                                                                           │
  │  Components ──► Structured Logger ──► stdout/file ──► Log Aggregator     │
  │       │                                                                   │
  │       │         ┌─────────────────┐                                       │
  │       └────────►│  Audit Logger   │──► Audit Storage                     │
  │                 │  (變更操作)      │                                       │
  │                 └─────────────────┘                                       │
  │                                                                           │
  └──────────────────────────────────────────────────────────────────────────┘
```

## 7. 並發控制

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Concurrency Control                                   │
└─────────────────────────────────────────────────────────────────────────────┘

  Process Manager 內部狀態保護:

  ┌──────────────────────────────────────────────────────────────────────────┐
  │                                                                           │
  │   ┌─────────────┐                                                         │
  │   │ Request A   │───┐                                                     │
  │   │ Start(:id)  │   │                                                     │
  │   └─────────────┘   │         ┌──────────────────────────┐               │
  │                     │         │    Process Manager       │               │
  │   ┌─────────────┐   │         │                          │               │
  │   │ Request B   │───┼────────►│  ┌──────────────────┐   │               │
  │   │ Stop(:id)   │   │         │  │   sync.RWMutex   │   │               │
  │   └─────────────┘   │         │  └────────┬─────────┘   │               │
  │                     │         │           │             │               │
  │   ┌─────────────┐   │         │           ▼             │               │
  │   │ Request C   │───┘         │  ┌──────────────────┐   │               │
  │   │ Status(:id) │             │  │ map[string]*Proc │   │               │
  │   └─────────────┘             │  └──────────────────┘   │               │
  │                               │                          │               │
  │                               └──────────────────────────┘               │
  │                                                                           │
  │   Lock Strategy:                                                          │
  │   - Start/Stop: Write Lock (Lock)                                        │
  │   - GetStatus/List: Read Lock (RLock)                                    │
  │                                                                           │
  └──────────────────────────────────────────────────────────────────────────┘

  Context Cancellation:

  ┌──────────────────────────────────────────────────────────────────────────┐
  │                                                                           │
  │   HTTP Request ──► context.Context ──┬──► CF API Call                    │
  │        │                             │                                    │
  │        │ Cancel                      └──► Process Start                   │
  │        ▼                                                                  │
  │   All Operations                                                          │
  │   Cancelled                                                               │
  │                                                                           │
  └──────────────────────────────────────────────────────────────────────────┘
```
